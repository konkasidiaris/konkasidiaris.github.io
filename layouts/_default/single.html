{{ define "main" }}
<div class="w-full py-8 px-4 max-w-5xl mx-auto relative post-page" style="view-transition-name: card-{{ .File.UniqueID }};">
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Table of Contents - Desktop (Absolutely positioned in left margin) -->
        <aside class="hidden 2xl:block fixed right-28 3xl:right-36 w-56 top-32 max-h-[calc(100vh-10rem)] bg-bg-muted/20 rounded-2xl p-6" data-pagefind-ignore="all">
            <nav class="sticky top-24 space-y-4">
                <h2 class="text-sm font-semibold text-text-base uppercase tracking-wide">Table of Contents</h2>
                <div class="space-y-2 text-sm">
                    {{ .TableOfContents }}
                </div>
            </nav>
        </aside>

        <!-- Main Content (full width on desktop) -->
        <article class="w-full mx-auto">
            {{ partial "breadcrumbs.html" . }}
            <!-- Header -->
            <header class="mb-12 flex flex-col gap-6 items-center">
                <h1 class="text-4xl md:text-5xl font-bold text-text-base leading-tight">
                    {{ .Title }}
                </h1>
                
                <!-- Meta information -->
                <div class="flex flex-wrap gap-4 text-sm text-text-muted">
                    <time datetime="{{ .Params.Date.Format "2006-01-02" }}" class="flex items-center gap-2">
                        {{ partial "svg/calendar.html" (dict "class" "size-4") }}
                        <span data-pagefind-sort="date">{{ .Params.Date.Format "January 2, 2006" }}</span>
                    </time>
                    
                    {{ if .Params.readingTime }}
                    <span class="flex items-center gap-2">
                        {{ partial "svg/clock.html" (dict "class" "size-4") }}
                        {{ .ReadingTime }} min read
                    </span>
                    {{ end }}
                </div>
                
                <!-- Tags -->
                {{ if .Params.tags }}
                 {{ $.Scratch.Set "filters" (slice) }}
                {{ range .Params.tags }}
                  {{ $.Scratch.Add "filters" (printf "tag[%s]" .) }}
                {{ end }}
                <div class="flex flex-wrap gap-2" data-pagefind-filter="{{ delimit ($.Scratch.Get "filters") ", " }}">
                    {{ range .Params.tags }}
                    <a href="/tags/{{ . | urlize }}" 
                       class="text-text-muted hover:text-primary text-xs transition-colors inline-flex gap-2">
                        {{ partial "svg/tag.html" (dict "class" "size-4") }} {{ . }}
                    </a>
                    {{ end }}
                </div>
                {{ end }}

                <p class="text-xs text-text-muted">tldr; {{ .Params.Summary }}</p>
                
                <!-- Featured image -->
                {{ if .Params.image }}
                {{ $img := "" }}
                {{ with .Resources.GetMatch .Params.image }}
                    {{ $img = . }}
                {{ else }}
                    {{ with resources.Get .Params.image }}
                        {{ $img = . }}
                    {{ end }}
                {{ end }}
                
                {{ if $img }}
                    {{ $jpg800 := $img.Resize "800x jpg q80" }}
                    {{ $jpg1600 := $img.Resize "1600x jpg q80" }}
                    {{ $webp800 := $img.Resize "800x webp q85" }}
                    {{ $webp1600 := $img.Resize "1600x webp q85" }}
                    
                    <figure class="rounded-2xl max-w-3xl overflow-hidden bg-bg-subtle w-full aspect-video">
                        <picture>
                            <source 
                                srcset="{{ $webp800.RelPermalink }} 800w, {{ $webp1600.RelPermalink }} 1600w"
                                sizes="(max-width: 768px) 100vw, 800px"
                                type="image/webp" />
                            <source 
                                srcset="{{ $jpg800.RelPermalink }} 800w, {{ $jpg1600.RelPermalink }} 1600w"
                                sizes="(max-width: 768px) 100vw, 800px"
                                type="image/jpeg" />
                            <img 
                                src="{{ $jpg1600.RelPermalink }}" 
                                alt="{{ .Title }}" 
                                class="w-full h-auto"
                                loading="eager" />
                        </picture>
                        {{ if .Params.imageCaption }}
                        <figcaption class="px-4 py-2 text-sm text-text-muted italic">
                            {{ .Params.imageCaption }}
                        </figcaption>
                        {{ end }}
                    </figure>
                {{ end }}
                {{ end }}
            </header>

            <!-- Table of Contents - Mobile -->
            <nav class="2xl:hidden mb-8 p-6 bg-bg-subtle rounded-2xl">
                <h2 class="text-sm font-semibold text-text-base uppercase tracking-wide mb-4">Table of Contents</h2>
                <div class="space-y-2 text-sm">
                    {{ .TableOfContents }}
                </div>
            </nav>
            
            {{ partial "prose.html" .Content }}
            
            <!-- Footer -->
            <footer class="mt-16 pt-8 border-t border-border space-y-8">
                <!-- Credits -->
                {{ if .Params.credits }}
                <div class="text-xs text-text-muted space-y-1">
                    <p class="font-semibold">Credits</p>
                    {{ range .Params.credits }}
                    <p>
                        {{ if .url }}
                        <a href="{{ .url }}" class="hover:text-primary transition-colors inline-flex gap-2" target="_blank" rel="noopener">
                            {{ .text }} {{ partial "svg/arrow-up-right.html" (dict "class" "size-4") }}
                        </a>
                        {{ else }}
                        {{ .text }}
                        {{ end }}
                    </p>
                    {{ end }}
                </div>
                {{ end }}
                
                <!-- Navigation -->
                <nav class="flex justify-between items-center text-sm">
                    {{ with .PrevInSection }}
                    <a href="{{ .RelPermalink }}" 
                       class="flex items-center gap-2 text-text-muted hover:text-primary transition-colors group">
                        {{ partial "svg/arrow-left.html" (dict "class" "size-4") }}
                        <span class="group-hover:underline">{{ .Title }}</span>
                    </a>
                    {{ else }}
                    <span></span>
                    {{ end }}
                    
                    {{ with .NextInSection }}
                    <a href="{{ .RelPermalink }}" 
                       class="flex items-center gap-2 text-text-muted hover:text-primary transition-colors group">
                        <span class="group-hover:underline">{{ .Title }}</span>
                        {{ partial "svg/arrow-right.html" (dict "class" "size-4") }}
                    </a>
                    {{ end }}
                </nav>
                
                <!-- Back to blog -->
                <div class="text-center">
                    {{ $item := "" }}
                    {{ if eq .Section "posts" }}
                      {{ $item = "posts" }}
                    {{ else if eq .Section "projects" }}
                      {{ $item = "projects" }}
                    {{ end }}
                    {{ if ne $item "" }}
                    <a href="/{{ $item }}" 
                       class="inline-flex items-center gap-2 px-6 py-3 bg-bg-muted hover:bg-primary hover:text-white rounded-full transition-colors">
                        {{ partial "svg/arrow-left.html" (dict "class" "size-4") }}
                        Back to all {{ $item }}
                    </a>
                    {{ end }}
                </div>
            </footer>
        </article>
    </div>
</div>

<style>
    #TableOfContents nav {
        padding-left: 0;
    }
    
    #TableOfContents ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }
    
    #TableOfContents ul ul {
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    
    #TableOfContents a {
        color: var(--color-text-muted);
        text-decoration: none;
        transition: color 0.2s;
        display: block;
        padding: 0;
    }
    
    #TableOfContents a:hover {
        color: var(--color-primary);
    }
    
    #TableOfContents a.active {
        color: var(--color-primary);
        font-weight: 600;
    }
</style>
{{ end }}