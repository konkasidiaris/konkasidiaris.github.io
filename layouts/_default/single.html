{{ define "main" }}
<div class="w-full py-8 px-4 max-w-5xl mx-auto relative">
    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Table of Contents - Desktop (Absolutely positioned in left margin) -->
        <aside class="hidden 2xl:block fixed right-28 3xl:right-36 w-56 top-32 max-h-[calc(100vh-10rem)] bg-bg-muted/20 rounded-2xl p-6">
            <nav class="sticky top-24 space-y-4">
                <h2 class="text-sm font-semibold text-text-base uppercase tracking-wide">Table of Contents</h2>
                <div id="toc-desktop" class="space-y-2 text-sm">
                    {{ .TableOfContents }}
                </div>
            </nav>
        </aside>

        <!-- Main Content (full width on desktop) -->
        <article class="w-full mx-auto">
            <!-- Header -->
            <header class="mb-12 flex flex-col gap-6 items-center">
                <h1 class="text-4xl md:text-5xl font-bold text-text-base leading-tight">
                    {{ .Title }}
                </h1>
                
                <!-- Meta information -->
                <div class="flex flex-wrap gap-4 text-sm text-text-muted">
                    <time datetime="{{ .Params.Date.Format "2006-01-02" }}" class="flex items-center gap-2">
                        {{ partial "svg/calendar.html" (dict "size" "size-4") }}
                        {{ .Params.Date.Format "January 2, 2006" }}
                    </time>
                    
                    {{ if .Params.readingTime }}
                    <span class="flex items-center gap-2">
                        {{ partial "svg/clock.html" (dict "size" "size-4") }}
                        {{ .ReadingTime }} min read
                    </span>
                    {{ end }}
                </div>
                
                <!-- Tags -->
                {{ if .Params.tags }}
                <div class="flex flex-wrap gap-2">
                    {{ range .Params.tags }}
                    <a href="/tags/{{ . | urlize }}" 
                       class="text-text-muted hover:text-primary text-xs transition-colors inline-flex gap-2">
                        {{ partial "svg/tag.html" (dict "class" "size-4") }} {{ . }}
                    </a>
                    {{ end }}
                </div>
                {{ end }}

                <p class="text-xs text-text-muted">tldr; {{ .Params.Summary }}</p>
                
                <!-- Featured image -->
                {{ if .Params.image }}
                {{ $img := "" }}
                {{ with .Resources.GetMatch .Params.image }}
                    {{ $img = . }}
                {{ else }}
                    {{ with resources.Get .Params.image }}
                        {{ $img = . }}
                    {{ end }}
                {{ end }}
                
                {{ if $img }}
                    {{ $jpg800 := $img.Resize "800x jpg q80" }}
                    {{ $jpg1600 := $img.Resize "1600x jpg q80" }}
                    {{ $webp800 := $img.Resize "800x webp q85" }}
                    {{ $webp1600 := $img.Resize "1600x webp q85" }}
                    
                    <figure class="rounded-2xl max-w-3xl overflow-hidden bg-bg-subtle w-full aspect-video">
                        <picture>
                            <source 
                                srcset="{{ $webp800.RelPermalink }} 800w, {{ $webp1600.RelPermalink }} 1600w"
                                sizes="(max-width: 768px) 100vw, 800px"
                                type="image/webp" />
                            <source 
                                srcset="{{ $jpg800.RelPermalink }} 800w, {{ $jpg1600.RelPermalink }} 1600w"
                                sizes="(max-width: 768px) 100vw, 800px"
                                type="image/jpeg" />
                            <img 
                                src="{{ $jpg1600.RelPermalink }}" 
                                alt="{{ .Title }}" 
                                class="w-full h-auto"
                                loading="eager" />
                        </picture>
                        {{ if .Params.imageCaption }}
                        <figcaption class="px-4 py-2 text-sm text-text-muted italic">
                            {{ .Params.imageCaption }}
                        </figcaption>
                        {{ end }}
                    </figure>
                {{ end }}
                {{ end }}
            </header>

            <!-- Table of Contents - Mobile -->
            <nav class="2xl:hidden mb-8 p-6 bg-bg-subtle rounded-2xl">
                <h2 class="text-sm font-semibold text-text-base uppercase tracking-wide mb-4">Table of Contents</h2>
                <div id="toc-mobile" class="space-y-2 text-sm">
                    {{ .TableOfContents }}
                </div>
            </nav>
            
            <!-- Content -->
            <div class="prose prose-lg 
                        prose-headings:text-text-base prose-headings:font-semibold
                        prose-h1:text-3xl prose-h1:mt-12 prose-h1:mb-6
                        prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4
                        prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
                        prose-p:text-text-base prose-p:leading-relaxed prose-p:mb-6
                        prose-a:text-primary prose-a:no-underline prose-a:hover:underline prose-a:transition-colors
                        prose-strong:text-text-base prose-strong:font-semibold
                        prose-em:text-text-muted prose-em:italic
                        prose-code:text-primary prose-code:bg-bg-subtle prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
                        prose-pre:bg-bg-subtle prose-pre:border prose-pre:border-border prose-pre:rounded-xl prose-pre:p-4
                        prose-blockquote:border-l-4 prose-blockquote:border-primary prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-text-muted
                        prose-ul:list-disc prose-ul:pl-6 prose-ul:mb-6
                        prose-ol:list-decimal prose-ol:pl-6 prose-ol:mb-6
                        prose-li:text-text-base prose-li:mb-2
                        prose-img:rounded-xl prose-img:shadow-lg
                        prose-hr:border-border prose-hr:my-12
                        max-w-none">
                {{ .Content }}
            </div>
            
            <!-- Footer -->
            <footer class="mt-16 pt-8 border-t border-border space-y-8">
                <!-- Credits -->
                {{ if .Params.credits }}
                <div class="text-xs text-text-muted space-y-1">
                    <p class="font-semibold">Credits</p>
                    {{ range .Params.credits }}
                    <p>
                        {{ if .url }}
                        <a href="{{ .url }}" class="hover:text-primary transition-colors inline-flex gap-2" target="_blank" rel="noopener">
                            {{ .text }} {{ partial "svg/arrow-up-right.html" (dict "size" "size-4") }}
                        </a>
                        {{ else }}
                        {{ .text }}
                        {{ end }}
                    </p>
                    {{ end }}
                </div>
                {{ end }}
                
                <!-- Navigation -->
                <nav class="flex justify-between items-center text-sm">
                    {{ with .PrevInSection }}
                    <a href="{{ .RelPermalink }}" 
                       class="flex items-center gap-2 text-text-muted hover:text-primary transition-colors group">
                        {{ partial "svg/arrow-left.html" (dict "size" "size-4") }}
                        <span class="group-hover:underline">{{ .Title }}</span>
                    </a>
                    {{ else }}
                    <span></span>
                    {{ end }}
                    
                    {{ with .NextInSection }}
                    <a href="{{ .RelPermalink }}" 
                       class="flex items-center gap-2 text-text-muted hover:text-primary transition-colors group">
                        <span class="group-hover:underline">{{ .Title }}</span>
                        {{ partial "svg/arrow-right.html" (dict "size" "size-4") }}
                    </a>
                    {{ end }}
                </nav>
                
                <!-- Back to blog -->
                <div class="text-center">
                    <a href="/posts" 
                       class="inline-flex items-center gap-2 px-6 py-3 bg-bg-muted hover:bg-primary hover:text-white rounded-full transition-colors">
                        {{ partial "svg/arrow-left.html" (dict "size" "size-4") }}
                        Back to all posts
                    </a>
                </div>
            </footer>
        </article>
    </div>
</div>

<style>
    /* Style the TOC */
    #toc-desktop nav, #toc-mobile nav {
        padding-left: 0;
    }
    
    #toc-desktop ul, #toc-mobile ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }
    
    #toc-desktop ul ul, #toc-mobile ul ul {
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    
    #toc-desktop a, #toc-mobile a {
        color: rgb(var(--text-muted));
        text-decoration: none;
        transition: color 0.2s;
        display: block;
        padding: 0;
    }
    
    #toc-desktop a:hover, #toc-mobile a:hover {
        color: rgb(var(--primary));
    }
    
    #toc-desktop a.active, #toc-mobile a.active {
        color: rgb(var(--primary));
        font-weight: 600;
    }
</style>
{{ end }}